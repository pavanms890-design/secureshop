{% extends 'base.html' %}
{% block title %}My Cart â€” SecureShop{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cart.css') }}">
{% endblock %}

{% block content %}

<!-- Hidden CSRF token so cart.js can read it -->
<input type="hidden" id="csrfHidden" name="csrf_token" value="{{ csrf_token() }}">

<div class="cart-page">
    <div class="cart-container">

        <!-- â”€â”€ LEFT: Cart Items â”€â”€ -->
        <div class="cart-left">
            <h2>
                <i class="fas fa-shopping-cart"></i> My Cart
                <span class="cart-count">({{ cart_items|length }} items)</span>
            </h2>

            {% if cart_items %}
            <div class="cart-items" id="cartItems">
                {% for item in cart_items %}
                <div class="cart-item" id="cartItem-{{ item.cart_id }}">

                    <!-- Product Image -->
                    <div class="item-image">
                        <img src="{{ item.image_url }}" alt="{{ item.name }}"
                             onerror="this.src='https://via.placeholder.com/80x80?text=IMG'">
                    </div>

                    <!-- Product Details -->
                    <div class="item-details">
                        <span class="item-category">{{ item.category }}</span>
                        <h3 class="item-name">{{ item.name }}</h3>
                        <div class="item-price">â‚¹{{ "%.0f"|format(item.price) }} per item</div>
                    </div>

                    <!-- Quantity + Actions -->
                    <div class="item-controls">
                        <!-- +/- Quantity -->
                        <div class="quantity-controls">
                            <button type="button"
                                onclick="updateQty({{ item.cart_id }}, {{ item.quantity - 1 }})">âˆ’</button>
                            <span id="qty-{{ item.cart_id }}">{{ item.quantity }}</span>
                            <button type="button"
                                onclick="updateQty({{ item.cart_id }}, {{ item.quantity + 1 }})">+</button>
                        </div>

                        <!-- Subtotal -->
                        <div class="item-subtotal" id="sub-{{ item.cart_id }}">
                            â‚¹{{ "%.0f"|format(item.price * item.quantity) }}
                        </div>

                        <!-- Fav + Remove -->
                        <div class="item-actions">
                            <button type="button" class="item-fav-btn"
                                    onclick="toggleFavorite({{ item.id }}, this)"
                                    title="Save for later">
                                <i class="fas fa-heart"></i>
                            </button>
                            <button type="button" class="item-remove-btn"
                                    onclick="removeFromCart({{ item.cart_id }})"
                                    title="Remove item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% else %}
            <!-- Empty Cart State -->
            <div class="empty-cart">
                <div class="empty-icon">ðŸ›’</div>
                <h3>Your cart is empty!</h3>
                <p>Browse our products and add something you like</p>
                <a href="{{ url_for('products') }}" class="btn-primary">
                    <i class="fas fa-box"></i> Browse Products
                </a>
            </div>
            {% endif %}
        </div>

        <!-- â”€â”€ RIGHT: Order Summary â”€â”€ -->
        {% if cart_items %}
        <div class="cart-right">
            <div class="order-summary">
                <h3><i class="fas fa-receipt"></i> Order Summary</h3>

                <div class="summary-row">
                    <span>Subtotal ({{ cart_items|length }} items)</span>
                    <span id="summarySubtotal">â‚¹{{ "%.0f"|format(total) }}</span>
                </div>
                <div class="summary-row">
                    <span>Delivery Charges</span>
                    <span class="free-delivery" id="deliveryCharge">
                        {% if total >= 499 %}FREE{% else %}â‚¹49{% endif %}
                    </span>
                </div>
                <div class="summary-row">
                    <span>Secured by</span>
                    <span>ðŸ”’ Razorpay</span>
                </div>

                <div class="summary-divider"></div>

                <div class="summary-total">
                    <span>Total Amount</span>
                    <span id="summaryTotal">
                        â‚¹{{ "%.0f"|format(total if total >= 499 else total + 49) }}
                    </span>
                </div>

                <a href="{{ url_for('payment') }}" class="checkout-btn">
                    <i class="fas fa-lock"></i> Proceed to Payment
                </a>

                <div class="secure-badges">
                    <span>ðŸ”’ SSL Secured</span>
                    <span>âœ… Safe Checkout</span>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<script src="{{ url_for('static', filename='js/cart.js') }}"></script>
<script>
// â”€â”€ Update item quantity â”€â”€
function updateQty(cartId, newQty) {
    if (newQty < 1) {
        removeFromCart(cartId);
        return;
    }
    fetch('/cart/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ cart_id: cartId, quantity: newQty })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Update quantity display
            const qtyEl = document.getElementById(`qty-${cartId}`);
            if (qtyEl) qtyEl.textContent = newQty;

            // Update totals
            updateSummary(data.total, data.cart_count);
        }
    });
}

// â”€â”€ Remove item from cart â”€â”€
function removeFromCart(cartId) {
    if (!confirm('Remove this item from cart?')) return;

    fetch('/cart/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ cart_id: cartId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Animate and remove item
            const item = document.getElementById(`cartItem-${cartId}`);
            if (item) {
                item.style.transition = 'opacity 0.3s ease, transform 0.3s ease, max-height 0.3s ease';
                item.style.opacity = '0';
                item.style.transform = 'translateX(60px)';
                item.style.overflow = 'hidden';
                item.style.maxHeight = item.offsetHeight + 'px';
                setTimeout(() => {
                    item.style.maxHeight = '0';
                    item.style.padding = '0';
                    item.style.margin = '0';
                    setTimeout(() => item.remove(), 300);
                }, 300);
            }
            updateSummary(data.total, data.cart_count);
            showToast('Item removed from cart', 'info');
        }
    });
}

// â”€â”€ Update price summary in sidebar â”€â”€
function updateSummary(subtotal, cartCount) {
    const subEl      = document.getElementById('summarySubtotal');
    const totalEl    = document.getElementById('summaryTotal');
    const deliveryEl = document.getElementById('deliveryCharge');
    const badgeEl    = document.getElementById('cartBadge');

    const sub = parseFloat(subtotal) || 0;
    const delivery = sub >= 499 ? 0 : 49;
    const grandTotal = sub + delivery;

    if (subEl)      subEl.textContent      = `â‚¹${Math.round(sub)}`;
    if (deliveryEl) deliveryEl.textContent  = delivery === 0 ? 'FREE' : `â‚¹${delivery}`;
    if (totalEl)    totalEl.textContent    = `â‚¹${Math.round(grandTotal)}`;
    if (badgeEl)    badgeEl.textContent    = cartCount;
}
</script>

{% endblock %}